---
title: 패밀리 형상으로 찾기 SQL
date: 2022-06-20
author: ideook
layout: post
---

## 유리 정보
* 총 유리 개수

* 단창, 이중창 확인

* 입면에서 유리 개수 확인

### 유리 가로/ 세로 개수
유리의 X, Z 좌표 오차를 보정하기 위해 좌표의 반올림을 할때 고정 값(소수점 첫째자리)으로 보정을 하면 작은 사이즈의 창문은 하나로 Merge 되어 버린다. 창문의 사이즈를 확인하여 비례적으로 적용하여야 한다.

CREATE PROCEDURE [dbo].[USP_GET_TB_FAMILY_GLASS_FIND_BY_COUNT]
(
   @normal nvarchar(1),
   @category nvarchar(30),
   @aspectRatio float,
)
WITH EXEC AS CALLER
AS
BEGIN
	
	select 
	    case @normal
	        when 'Y' then X
	        when 'X' then Y
	    end as XY, Z
	FROM 
		TB_FAMILY_SYM A
		left join TB_FAMILY B on B.SEQ = A.ID_REL_FML
	CROSS APPLY OPENJSON(A.GEOM_SYM, '$.Solids')
	WITH (
	    SurfaceArea float '$.SurfaceArea',
	    Volume float '$.Volume',
	    ComputeCentroid NVARCHAR(MAX) '$.ComputeCentroid',
	    BoundingBox NVARCHAR(MAX) '$.BoundingBox',
	    FacesCount int '$.FacesCount',
	    Faces NVARCHAR(MAX) '$.Faces' AS JSON,
	    Material NVARCHAR(MAX) '$.Material' AS JSON
	) As SOLID
	
	CROSS APPLY OPENJSON(Faces,'$')
	WITH (
	    Area NVARCHAR(MAX) '$.Area',  
	    FaceNormal NVARCHAR(MAX)  '$.FaceNormal',  
	    Origin NVARCHAR(MAX)  '$.Origin' AS JSON,
	    AspectRatio float '$.AspectRatio',
	    EdgeLoopsCount int '$.EdgeLoopsCount',  
	    EdgeArray NVARCHAR(MAX) '$.EdgeArray' AS JSON
	) As FACE
	
	CROSS APPLY OPENJSON(Origin,'$')
	WITH (
	    X float '$.X', 
	    Y float '$.Y',
	    Z float '$.Z'
	) As ORIGIN
	
	CROSS APPLY OPENJSON(Material,'$')
	WITH (
	    Name NVARCHAR(MAX)  '$.Name', 
	    Transparency int '$.Transparency',
	    [Parameter] NVARCHAR(MAX) '$.Parameter' AS JSON
	) As MATERIAL
	
	CROSS APPLY OPENJSON(EdgeArray,'$')
	WITH (
	    EdgesCount int '$.EdgesCount',  
	    TotalLength float '$.TotalLength'
	) As EDGEARRAY
	
	WHERE
		ISJSON(A.GEOM_SYM) > 0 AND 
		-- NM_SYM like '%900%' AND 
		Transparency > 0 AND
		AspectRatio > @aspectRatio AND
		B.NM_CATG = @category AND 
		A.SEQ = 706
	GROUP BY 
	    case @normal
	        when 'Y' then X
	        when 'X' then Y
	    end, Z

END;





DECLARE @category nvarchar(30);
DECLARE @aspectRatio float;
DECLARE @normal nvarchar(1);
DECLARE @cursor CURSOR
SET @category = 'Windows'
SET @aspectRatio = 0.2	


---SET @cursor = CURSOR FOR
SELECT 
	@normal = FaceNormal
FROM 
	TB_FAMILY_SYM A
	left join TB_FAMILY B on B.SEQ = A.ID_REL_FML
CROSS APPLY OPENJSON(A.GEOM_SYM, '$.Solids')
WITH (
    Faces NVARCHAR(MAX) '$.Faces' AS JSON,
    Material NVARCHAR(MAX) '$.Material' AS JSON
) As SOLID

CROSS APPLY OPENJSON(Faces,'$')
WITH (
    FaceNormal NVARCHAR(MAX) '$.FaceNormal',
    AspectRatio float '$.AspectRatio'
) As FACE

CROSS APPLY OPENJSON(Material,'$')
WITH (
    Name NVARCHAR(MAX)  '$.Name', 
    Transparency int '$.Transparency'
) As MATERIAL

WHERE
	ISJSON(A.GEOM_SYM) > 0 AND 
	Transparency > 0 AND
	AspectRatio > @aspectRatio AND 
	B.NM_CATG = @category AND 
	A.ID_REL_FML = 706
GROUP BY 
	FaceNormal

	
select 
    count(A.SEQ)
FROM 
	TB_FAMILY_SYM A
	left join TB_FAMILY B on B.SEQ = A.ID_REL_FML
CROSS APPLY OPENJSON(A.GEOM_SYM, '$.Solids')
WITH (
    SurfaceArea float '$.SurfaceArea',
    Volume float '$.Volume',
    ComputeCentroid NVARCHAR(MAX) '$.ComputeCentroid',
    BoundingBox NVARCHAR(MAX) '$.BoundingBox',
    FacesCount int '$.FacesCount',
    Faces NVARCHAR(MAX) '$.Faces' AS JSON,
    Material NVARCHAR(MAX) '$.Material' AS JSON
) As SOLID

CROSS APPLY OPENJSON(Faces,'$')
WITH (
    Area NVARCHAR(MAX) '$.Area',  
    FaceNormal NVARCHAR(MAX)  '$.FaceNormal',  
    Origin NVARCHAR(MAX)  '$.Origin' AS JSON,
    AspectRatio float '$.AspectRatio',
    EdgeLoopsCount int '$.EdgeLoopsCount',  
    EdgeArray NVARCHAR(MAX) '$.EdgeArray' AS JSON
) As FACE

CROSS APPLY OPENJSON(Origin,'$')
WITH (
    X float '$.X', 
    Y float '$.Y',
    Z float '$.Z'
) As ORIGIN

CROSS APPLY OPENJSON(Material,'$')
WITH (
    Name NVARCHAR(MAX)  '$.Name', 
    Transparency int '$.Transparency',
    [Parameter] NVARCHAR(MAX) '$.Parameter' AS JSON
) As MATERIAL

CROSS APPLY OPENJSON(EdgeArray,'$')
WITH (
    EdgesCount int '$.EdgesCount',  
    TotalLength float '$.TotalLength'
) As EDGEARRAY

WHERE
	ISJSON(A.GEOM_SYM) > 0 AND 
	-- NM_SYM like '%900%' AND 
	Transparency > 0 AND
	AspectRatio > @aspectRatio AND
	B.NM_CATG = @category AND 
	A.ID_REL_FML = 706

	
	
SELECT
	count(*) 
FROM
	TB_FAMILY 
	
	
WHERE SEQ = 582
	
	
SELECT
	*
FROM 
	TB_FAMILY_SYM
WHERE
	SEQ = 1152
	
	
	
delete from TB_FAMILY where 1=1;
delete from TB_FAMILY_FILE  where 1=1;
delete from TB_FAMILY_PARAM  where 1=1;
delete from TB_FAMILY_RELATION  where 1=1;
delete from TB_FAMILY_SYM  where 1=1;


 
 
	
select 
    case @normal
        when 'Y' then abs(X)
        when 'X' then abs(Y)
    end as XY, abs(Z)